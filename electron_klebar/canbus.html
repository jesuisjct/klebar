<script type="text/javascript">
var http = require('http'); 

var $commanddropDownItems = $('#command_dropdown').children();
$commanddropDownItems.on('click', function() {
      $("#command_canbus").val($(this).html())
})

var $statedropDownItems = $('#state_dropdown').children();
$statedropDownItems.on('click', function() {
      $("#param1_canbus").val($(this).html())
})

function copy_cmd()
{
  var x = $("#command_dropdown").SelectedIndex
  $("#command_canbus").val(x)
  window.alert(x)
}

function command_canbus(node, command, rtr, param1, param2)
{ if(node)    node = node.trim()
  else
  { $("#status_canbus").html(`Error node is empty `)
    return
  }
  if(command) command = command.trim()
  if(rtr)     rtr = rtr.trim()
  else        rtr = ""
  if(param1)   param1 = param1.trim()
  if(param2)   param2 = param2.trim()
  config.path = "/can" + "?node=" + node + "&command=" + command + "&param1=" + param1 + "&param2=" + param2 + "&rtr=" + rtr
  console.log(config)
  const req = http.request(config, res => {
      console.log(`statusCode: ${res.statusCode}`)
      $("#status_canbus").html(`Status code  : ${res.statusCode} ${res.statusMessage} `)
      res.on('data', message => {
        console.log("data :" + message)
        $("#response_canbus").html(" " + message)
      })
  })
  
  req.on('error', error => {
      console.error(error)
      $("#status_canbus").html("Error :" + error)
  })
  
  req.end()
}

function send_canbus()
{
    if($("#command_canbus").val() == "") 
    {   $("#status_canbus").html("error : command is empty")
        return;
    }
    let cocan = $("#command_canbus").val()
    let comcan = cocan.split(":")[1]
    if(!comcan) comcan = cocan
    let par1 = $("#param1_canbus").val()
    let param1 = par1.split(":")[1]
    if(!param1)  param1 = par1
    let param2 = $("#param2_canbus").val()   
    let parrtr = cocan.split(":")[2]

    command_canbus($("#node_canbus").val(), comcan, parrtr, param1, param2)
}

</script>

<div>
    <br>
    Klebar CAN bus control
    <br> <br>
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span style="width: 120px; " class="input-group-text" id="inputGroup-sizing-default">node</span>
      </div>
      <input id="node_canbus"  type="text" class="form-control" aria-label="Command" aria-describedby="inputGroup-sizing-default">
    </div>
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <button id="cmd" class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Command</button>
        <div id="command_dropdown" class="dropdown-menu">
          <a class:"dropdown-item" href="#">CO_NMT_CTRL : 0x000  </a>
          <a class="dropdown-item" href="#">ODRIVE_HEARTBEAT  :1  </a>
          <a class="dropdown-item" href="#">ODRIVE_ESTOP  :2  </a>
          <a class="dropdown-item" href="#">GET_MOTOR_ERROR :3:rtr </a>
          <a class="dropdown-item" href="#">GET_ENCODER_ERROR :4:rtr </a>
          <a class="dropdown-item" href="#">GET_SENSORLESS_ERROR  :5:rtr  </a>
          <a class="dropdown-item" href="#">SET_AXIS_NODE_ID  :6  </a>
          <a class="dropdown-item" href="#">SET_AXIS_REQUESTED_STATE  :7  </a>
          <a class="dropdown-item" href="#">SET_AXIS_STARTUP_CONFIG :8 </a>
          <a class="dropdown-item" href="#">GET_ENCODER_ESTIMATES :9:rtr </a>
          <a class="dropdown-item" href="#">GET_ENCODER_COUNT :10:rtr </a>
          <a class="dropdown-item" href="#">SET_CONTROLLER_MODES  :11 </a>
          <a class="dropdown-item" href="#">SET_INPUT_POS :12 </a>
          <a class="dropdown-item" href="#">SET_INPUT_VEL :13 </a>
          <a class="dropdown-item" href="#">SET_INPUT_CURRENT :14 </a>
          <a class="dropdown-item" href="#">SET_VEL_LIMIT :15 </a>
          <a class="dropdown-item" href="#">START_ANTICOGGING :16   </a>
          <a class="dropdown-item" href="#">SET_TRAJ_VEL_LIMIT  :17  </a>
          <a class="dropdown-item" href="#">SET_TRAJ_ACCEL_LIMITS :18 </a>
          <a class="dropdown-item" href="#">SET_TRAJ_A_PER_CSS  :19  </a>
          <a class="dropdown-item" href="#">GET_IQ  :20:rtr  </a>
          <a class="dropdown-item" href="#">GET_SENSORLESS_ESTIMATES  :21:rtr  </a>
          <a class="dropdown-item" href="#">RESET_ODRIVE  :22  </a>
          <a class="dropdown-item" href="#">GET_VBUS_VOLTAGE  :23:rtr  </a>
          <a class="dropdown-item" href="#">CLEAR_ERRORS  :24  </a>
          <a class="dropdown-item" href="#">CO_HEARTBEAT_CMD :0x700 </a>
          <div role="separator" class="dropdown-divider"></div>
        </div>
      </div>
      <input id="command_canbus" type="text" class="form-control" aria-label="Parameter" aria-describedby="inputGroup-sizing-default">
    </div>    
    
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span style="width: 120px; " class="input-group-text" id="inputGroup-sizing-default">Parameter</span>
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">State</button>
        <div id="state_dropdown" class="dropdown-menu">
          <button class="dropdown-item" href="#">State</button>
          <a class="dropdown-item" href="#">AXIS_STATE_UNDEFINED : 0  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_IDLE : 1  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_STARTUP_SEQUENCE : 2  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_FULL_CALIBRATION_SEQUENCE : 3  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_MOTOR_CALIBRATION : 4  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_SENSORLESS_CONTROL : 5  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_ENCODER_INDEX_SEARCH : 6  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_ENCODER_OFFSET_CALIBRATION : 7  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_CLOSED_LOOP_CONTROL : 8  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_LOCKIN_SPIN : 9  </a>
          <a class="dropdown-item" href="#">AXIS_STATE_ENCODER_DIR_FIND : 10  </a>
        </div>    
      </div>
      <input id="param1_canbus" type="text" class="form-control" aria-label="Parameter" aria-describedby="inputGroup-sizing-default">
    </div>

    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span style="width: 120px; " class="input-group-text" id="inputGroup-sizing-default">Parameter2</span>
      </div>
      <input id="param2_canbus" type="text" class="form-control" aria-label="Parameter" aria-describedby="inputGroup-sizing-default">
    </div>

    <br><br>
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span style="width: 120px; " class="input-group-text">Status</span>
      </div>
      <textarea id="status_canbus" readonly class="form-control" aria-label="Status"></textarea>
    </div>
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span style="width: 120px; " class="input-group-text">Response</span>
      </div>
      <textarea id="response_canbus" readonly class="form-control" aria-label="Response"></textarea>
    </div>

    <br><br>
    <button type="button" class="btn btn-light" onclick="send_canbus()"> Send CAN bus </button>
    <br>
  </div>